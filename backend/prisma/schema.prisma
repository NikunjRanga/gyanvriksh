generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String         @unique
  name      String?
  createdAt DateTime?      @default(now()) @db.Timestamptz(6)
  updatedAt DateTime?      @default(now()) @updatedAt @db.Timestamptz(6)
  families  FamilyMember[]
  lessons   Lesson[]
  stories   Story[]

  @@map("users")
}

model Family {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  description    String?
  createdAt      DateTime?       @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime?       @default(now()) @updatedAt @db.Timestamptz(6)
  members        FamilyMember[]
  knowledgeNodes KnowledgeNode[]
  stories        Story[]

  @@map("families")
}

model FamilyMember {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  familyId  String    @db.Uuid
  name      String
  role      String?
  birthDate DateTime? @db.Timestamptz(6)
  bio       String?
  createdAt DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  family    Family    @relation(fields: [familyId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, familyId])
  @@index([familyId], map: "idx_family_members_family_id")
  @@index([userId], map: "idx_family_members_user_id")
  @@map("family_members")
}

model Story {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  elderName   String
  userId      String    @db.Uuid
  familyId    String?   @db.Uuid
  mediaType   String
  mediaUrl    String
  mediaSize   Int?
  transcript  String?
  description String?
  prompt      String?
  date        DateTime? @default(now()) @db.Timestamptz(6)
  tags        String[]  @default([])
  createdAt   DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  lessons     Lesson[]
  family      Family?   @relation(fields: [familyId], references: [id], onUpdate: NoAction)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([familyId], map: "idx_stories_family_id")
  @@index([userId], map: "idx_stories_user_id")
  @@map("stories")
}

model Lesson {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title     String
  content   String
  summary   String?
  storyId   String    @db.Uuid
  userId    String    @db.Uuid
  tags      String[]  @default([])
  createdAt DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([storyId], map: "idx_lessons_story_id")
  @@map("lessons")
}

model KnowledgeNode {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type        String
  title       String
  description String?
  familyId    String?   @db.Uuid
  createdAt   DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  family      Family?   @relation(fields: [familyId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("knowledge_nodes")
}

model FamilyTreeRelation {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  parentId     String?
  childId      String
  relationType String
  familyId     String?
  createdAt    DateTime? @default(now()) @db.Timestamptz(6)

  @@map("family_tree_relations")
}
